<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title> Forgot Password </title>
	<style>
		body {
			background-image: url("https://i.imgur.com/3e5VlB7.jpg");
			background-size: cover;
		}
	</style>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
<div th:fragment="content">

	<script th:inline="javascript">
        var app = angular.module('myApp', []);
        app
            .controller(
                'forgotPasswordCtrl',
                function($scope, $http) {
                    var baseUrl = "/iTrust2/api/v1";

                    $scope.email = "";
                    $scope.username = "";
                    $scope.password = "";
                    $scope.repeatPassword = "";
                    $scope.key = "";




					 /* makes sure both passwords match */
                    function passwordsMatch() {
                        if(password.equals(repeatPassword) && password.isValidPassword()){
                            return true;
						}
                            return false;
                     };


                    //checks to see if the enterd email exists in the DB
					function validEmail(){

                        $http.get("/iTrust2/api/v1/patients").then(
                            function(response) {
                                $scope.patients = response.data;
                            });

                        $http.get("/iTrust2/api/v1/personnel").then(
                            function(response) {
                                $scope.personnel = response.data;
                            });

                        for(var i = 0; i < $scope.patients.length; i++){
                            if( $scope.patients[i].email.equals($scope.email)){
                                return true;
							}
						}

                        for(var i = 0; i < $scope.personnel.length; i++) {
                            if ($scope.personnel[i].email.equals($scope.email)) {
                                return true;
                            }
                        }

                        return false;

                    }

                    //Assures that the password the user picks is a valid one
                    function isValidPassword() {
                        if($scope.password.length >= 6 && $scope.password.length <= 20){
                            return true;
						}
						return false;
                    };


                    //ensures that passwords match and are the appropriate length
                    $scope.validateData = function() {

                        if (!passwordsMatch()) {
                            $scope.errorMsg = "Passwords must match";
                            return false;
                        }

                        if (!isValidPassword() ){
                            $scope.errorMsg = "Password should be between 6 and 20 characters";
                            return false;
						}

                        return true;
                    };


                    $scope.sendEmail = function() {
                       if(validEmail()){
                           //send the email
					   }else{
                           $scope.errorMsg = "That email address is not in the iTrust2 system"
					   }
                    }

                    $scope.resetForm = function() {
                        $scope.email = "";
                        $scope.username = "";
                        $scope.password = "";
                        $scope.repeatPassword = "";
                        $scope.errorMsg = "";
                        $scope.key = "";

                    }

					/* Send data to backend */
                    $scope.submit = function() {
                        var url = baseUrl + "/password/{id}";
                        $scope.message = "";
                        $scope.errorMsg = "";
                        $scope.resetRequest = null;


                        if ($scope.validateData()) {
                            $scope.resetRequest.password = $scope.password;
                            $scope.resetRequest.repassword = $scope.repeatPassword;
                            $scope.resetRequest.key = $scope.key;

                            $http({
                                method : "POST",
                                url : url,
                                data : $scope.resetRequest
                            }).then(function(response) {
                                $scope.message = response.data;
                                $scope.resetForm();
                                console.log(response);
                            }, function(rejection) {
                                $scope.message = "An error occurred";
                                $scope.errorMsg += rejection.data;
                                console.log(rejection);
                            });
                        }
                        else {
                            $scope.message = "An error occurred"
                        }
                    };

                });
	</script>

	<div ng-app="myApp" ng-controller="forgotPasswordCtrl">

		<!-- information on vertical rule found here: https://stackoverflow.com/questions/571900/is-there-a-vr-vertical-rule-in-html  -->
		<div style="float:left;width:70%;border-left:1px solid #bbb;padding: 3%;height:75%;overflow-y:auto">
			<h2>Please enter information:</h2>
				<table>
					<tr>
					<td>Email</td>
					<td><input type="text" id="email" ng-model="email" placeholder="email" /></td>
				</tr>

					<button ng-click="sendEmail()" name="sendEmail">Send Reset Key</button>

					<tr>
						<td>Reset Key:</td>
						<td><input type="text" id="key" ng-model="key" placeholder="key" /></td>
					</tr>
					<tr>
						<td>Username:</td>
						<td><input type="text" id="username" ng-model="username" placeholder="username" /></td>
					</tr>
					<tr>
						<td>Password:</td>
						<td><input type="text" id="password" ng-model="password" placeholder="password" /></td>
					</tr>
					<tr>
						<td>Repeat Password:</td>
						<td><input type="text" id="repeatPassword" ng-model="repeatPassword" placeholder="repeat password"></td>
					</tr>
				</table>
				<br />
				<button ng-click="submit()" name="submit">Submit Reset Request</button>
				<div name="errorMsg"><pre>{{errorMsg}}</pre></div>
				<div name="success">{{message}}</div>
		</div>
	</div>
</div>
</body>
</html>